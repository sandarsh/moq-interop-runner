name: Interop Report

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
    inputs:
      build_from_source:
        description: 'Build source-based images from scratch instead of pulling pre-built from GHCR'
        type: boolean
        default: false


permissions:
  contents: write

concurrency:
  group: interop-report
  cancel-in-progress: false

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: main

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-site

      - name: Pull pre-built images from GHCR
        if: "!inputs.build_from_source"
        working-directory: main
        run: |
          echo "Pulling pre-built source-build images from GHCR..."
          jq -r '.implementations[].roles[].docker.image // empty' implementations.json \
            | grep '^ghcr.io/' \
            | sort -u \
            | while read -r image; do
                echo "Pulling $image..."
                docker pull "$image" || echo "WARNING: Failed to pull $image"
              done

      - name: Build from source
        if: inputs.build_from_source
        working-directory: main
        run: |
          # Build moq-rs (draft-14)
          ./builds/moq-rs/build.sh
          # Re-tag to GHCR-qualified names that implementations.json expects
          docker tag moq-relay-ietf:latest ghcr.io/englishm/moq-interop-runner-moq-relay-ietf:latest
          docker tag moq-test-client:latest ghcr.io/englishm/moq-interop-runner-moq-test-client:latest

          # Build moq-rs-draft-16
          ./builds/moq-rs/build.sh \
            --repo https://github.com/englishm-cloudflare/moq-rs-1 \
            --ref me/draft-16-interop
          docker tag moq-relay-ietf:latest ghcr.io/englishm/moq-interop-runner-moq-relay-ietf-draft-16:latest
          docker tag moq-test-client:latest ghcr.io/englishm/moq-interop-runner-moq-test-client-draft-16:latest

      - name: Build adapters
        working-directory: main
        continue-on-error: true  # Adapter builds may fail (e.g., disk space) — run what we can
        run: make build-adapters

      - name: Generate TLS certificates
        working-directory: main
        run: ./generate-certs.sh ./certs

      - name: Run interop tests
        working-directory: main
        continue-on-error: true  # Some tests may fail — publish results regardless
        run: make interop-all

      - name: Publish results
        run: |
          NEW_RESULT=$(ls -td main/results/*/ 2>/dev/null | head -1)
          if [ -z "$NEW_RESULT" ]; then
            echo "No results produced — skipping publish"
            exit 0
          fi

          TIMESTAMP=$(basename "$NEW_RESULT")
          DEST="gh-pages-site/results/$TIMESTAMP"

          mkdir -p "$DEST"
          cp -r "$NEW_RESULT/"* "$DEST/"

          # Copy mlogs into results if they exist (produced by Docker-based tests)
          if [ -d main/mlog ] && [ "$(ls -A main/mlog/client 2>/dev/null)" ]; then
            mkdir -p "$DEST/mlog"
            cp -r main/mlog/* "$DEST/mlog/"
          fi

          # Generate index and detail reports for all runs
          cp main/generate-report.sh gh-pages-site/
          cp -r main/lib gh-pages-site/

          cd gh-pages-site
          ./generate-report.sh

          mv results/index.html index.html
          # Safer replacement: only modify hrefs that look like dates (YYYY-)
          sed -i 's|href="\([0-9]\{4\}-\)|href="results/\1|g' index.html
          # Fix back-links in detail reports: index.html moved from results/ to site root
          sed -i 's|href="../index.html"|href="../../index.html"|g' results/*/report.html

          rm generate-report.sh
          rm -rf lib

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Add interop results for $TIMESTAMP"
          git push origin gh-pages

